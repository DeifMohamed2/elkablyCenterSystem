<!DOCTYPE html>
<html lang="ar" dir="rtl">

  <%- include("./partials/head.ejs") %>
  <style>
    .otp-input { letter-spacing: 0.5rem; text-align: center; font-size: 1.2rem; }
  </style>
  <body class="g-sidenav-show rtl bg-gray-100">
    <%- include("./partials/aside.ejs") %>

    <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
      <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur" data-scroll="true">
        <div class="container-fluid pt-1 px-3">
          <h4>تغيير باسورد الادمن</h4>
        </div>
      </nav>

      <div class="container-fluid py-2">
        <div class="row">
          <div class="col-md-8 mx-auto">
            <div class="card mt-4">
              <div class="card-header pb-0 p-3">
                <h5 class="mb-0">تحقق وإرسال OTP</h5>
              </div>
              <div class="card-body p-3">
                <form id="requestOtpForm">
                  <div class="row">
                    <div class="col-md-6">
                      <label class="form-label">رقم الهاتف</label>
                      <input type="text" class="form-control border border-2 p-2" id="adminPhone" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">الباسورد الحالي</label>
                      <input type="password" class="form-control border border-2 p-2" id="currentPassword" required>
                    </div>
                  </div>
                  <div class="mt-3">
                    <button class="btn bg-gradient-dark" type="submit" id="sendOtpBtn"><i class="material-symbols-rounded text-sm">lock</i>&nbsp;&nbsp;<span id="sendOtpLabel">ارسال OTP</span></button>
                    <span id="otpTimer" class="ms-3 text-danger"></span>
                  </div>
                </form>
              </div>
            </div>

            <div class="card mt-4">
              <div class="card-header pb-0 p-3">
                <h5 class="mb-0">ادخل OTP وتعيين باسورد جديد</h5>
              </div>
              <div class="card-body p-3">
                <form id="verifyOtpForm">
                  <div class="row">
                    <div class="col-md-6">
                      <label class="form-label">OTP</label>
                      <input type="text" class="form-control border border-2 p-2 otp-input" id="otpCode" maxlength="6" minlength="6">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">باسورد جديد</label>
                      <input type="password" class="form-control border border-2 p-2" id="newPassword" required>
                    </div>
                  </div>
                  <div class="mt-3">
                    <button class="btn bg-gradient-dark" type="submit"><i class="material-symbols-rounded text-sm">check</i>&nbsp;&nbsp;تغيير الباسورد</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="alert alert-success mt-3" id="successMsg" style="display:none">تم تغيير الباسورد بنجاح</div>
            <div class="alert alert-danger mt-3" id="errorMsg" style="display:none"></div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      const otpTimer = document.getElementById('otpTimer');
      let expiryTs = null; let timerId = null;

      function startTimer(expiresAt){
        expiryTs = expiresAt; clearInterval(timerId);
        timerId = setInterval(()=>{
          const remain = Math.max(0, Math.floor((expiryTs - Date.now())/1000));
          const m = String(Math.floor(remain/60)).padStart(2,'0');
          const s = String(remain%60).padStart(2,'0');
          otpTimer.textContent = remain>0 ? `ستنتهي صلاحيته خلال ${m}:${s}` : 'انتهت صلاحية الكود';
          if (remain<=0) clearInterval(timerId);
        }, 1000);
      }

      document.getElementById('requestOtpForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); errorMsg.style.display='none'; successMsg.style.display='none';
        const phoneNumber = document.getElementById('adminPhone').value;
        const currentPassword = document.getElementById('currentPassword').value;
        const btn = document.getElementById('sendOtpBtn');
        const label = document.getElementById('sendOtpLabel');
        btn.disabled = true; label.textContent = 'تم الإرسال';
        const res = await fetch('/admin/change-password/request-otp', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phoneNumber, currentPassword })});
        const data = await res.json().catch(()=>({}));
        if (!res.ok){ errorMsg.textContent = data.error || 'فشل ارسال OTP'; errorMsg.style.display='block'; btn.disabled=false; label.textContent='ارسال OTP'; return; }
        startTimer(data.expiresAt);
      });

      document.getElementById('verifyOtpForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); errorMsg.style.display='none'; successMsg.style.display='none';
        const otp = document.getElementById('otpCode').value; const newPassword = document.getElementById('newPassword').value;
        const res = await fetch('/admin/change-password/verify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ otp, newPassword })});
        const data = await res.json().catch(()=>({}));
        if (!res.ok){ errorMsg.textContent = data.error || 'فشل تغيير الباسورد'; errorMsg.style.display='block'; return; }
        successMsg.style.display='block';
      });
    </script>
    <script src="../assets/js/core/popper.min.js"></script>
    <script src="../assets/js/core/bootstrap.min.js"></script>
    <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
    <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  </body>
  </html>


